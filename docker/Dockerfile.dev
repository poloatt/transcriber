FROM continuumio/miniconda3:latest

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    python3-dev \
    portaudio19-dev \
    libasound2-dev \
    libportaudio2 \
    ffmpeg \
    && rm -rf /var/lib/apt/lists/*

# Create conda environment
RUN conda create -n myenv python=3.8 -y
SHELL ["conda", "run", "-n", "myenv", "/bin/bash", "-c"]

# Install PyTorch and related packages using conda
RUN conda install -y pytorch torchvision torchaudio cpuonly -c pytorch

# Copy and install other requirements
COPY requirements.txt .
RUN pip install --no-cache-dir $(grep -v "torch\|torchvision\|torchaudio" requirements.txt)

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    FLASK_APP=app/__init__.py \
    FLASK_ENV=development \
    PORT=5002

# Setup application
COPY . /app
RUN mkdir -p /app/static

# Expose port
EXPOSE 5002

# Update CMD to use conda environment
CMD ["conda", "run", "--no-capture-output", "-n", "myenv", "python", "-m", "flask", "run", "--host=0.0.0.0", "--port=5002"]
